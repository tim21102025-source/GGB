<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Открываем GoGoBag…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XFYPYZT9ME"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XFYPYZT9ME', { send_page_view: false });
  </script>

  <script>
    (function () {
      console.log('Smartlink started'); // Лог для теста

      const params = new URLSearchParams(location.search);
      const hash = location.hash;
      const fullQuery = location.search + hash;

      // Защита fbclid
      if (params.has('fbclid')) {
        params.set('fb_click_id', params.get('fbclid'));
      }
      const queryString = params.toString() ? '?' + params.toString() : '';

      console.log('Query string:', queryString); // Лог параметров

      // Базовые ссылки
      const appStore = 'https://apps.apple.com/app/id6740579444' + fullQuery;
      const playStore = 'https://play.google.com/store/apps/details?id=com.gogobag.android' + queryString;

      // Точная проверка платформы
      const ua = navigator.userAgent.toLowerCase();
      const isIOS = /iphone|ipad|ipod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isAndroid = /android/.test(ua) && !/linux; android/.test(ua); // Исключаем Chrome OS

      console.log('Detected platform:', isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'); // Лог платформы

      let finalUrl = isIOS ? appStore : playStore;

      // Событие в GA4
      gtag('event', 'smartlink_click', {
        platform: isIOS ? 'ios' : isAndroid ? 'android' : 'desktop',
        utm_source: params.get('utm_source') || 'direct',
        utm_medium: params.get('utm_medium') || null,
        utm_campaign: params.get('utm_campaign') || null,
        utm_term: params.get('utm_term') || null,
        utm_content: params.get('utm_content') || null
      });

      console.log('Redirecting to:', finalUrl); // Лог финальной ссылки

      // Мгновенный редирект без replace (более надёжно для мобильных)
      window.location.href = finalUrl;
    })();
  </script>

  <!-- Noscript fallback -->
  <noscript>
    <meta http-equiv="refresh" content="0;url=https://play.google.com/store/apps/details?id=com.gogobag.android">
  </noscript>
</head>
<body>
  <!-- Пусто для мгновенного редиректа -->
</body>
</html>
