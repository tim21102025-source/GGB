<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Открываем GoGoBag…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Только твой Google Analytics 4 (уже правильный ID) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XFYPYZT9ME"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XFYPYZT9ME', { send_page_view: false });
  </script>

  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      const hash = location.hash;
      const fullQuery = location.search + hash;

      // Защита от обрезания fbclid (Meta всё равно любит это делать)
      if (params.has('fbclid')) {
        params.set('fb_click_id', params.get('fbclid'));
      }
      const queryString = params.toString() ? '?' + params.toString() : '';

      // Ссылки с автоматической подстановкой всех параметров
      const appStore   = 'https://apps.apple.com/app/id6740579444' + fullQuery;
      const playStore  = 'https://play.google.com/store/apps/details?id=com.gogobag.android' + fullQuery;

      const ua = navigator.userAgent.toLowerCase();
      const isIOS = /iphone|ipad|ipod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isAndroid = /android/.test(ua);

      let finalUrl = isIOS ? appStore : playStore;

      // Отправляем событие в GA4 — это главное, что ты сейчас увидишь
      gtag('event', 'smartlink_click', {
        platform: isIOS ? 'ios' : isAndroid ? 'android' : 'desktop',
        utm_source: params.get('utm_source') || 'direct',
        utm_medium: params.get('utm_medium') || null,
        utm_campaign: params.get('utm_campaign') || null,
        utm_term: params.get('utm_term') || null,
        utm_content: params.get('utm_content') || null
      });

      // Резервный фолбэк через 1.3 сек (чтобы не было белого экрана)
      let redirected = false;
      setTimeout(() => {
        if (!redirected) {
          redirected = true;
          window.location.href = finalUrl;
        }
      }, 1300);

      // Основной мгновенный редирект
      redirected = true;
      window.location.replace(finalUrl);
    })();
  </script>

  <!-- Если JS выключен вообще (крайне редко) — уйдёт в Google Play -->
  <noscript>
    <meta http-equiv="refresh" content="0;url=https://play.google.com/store/apps/details?id=com.gogobag.android?utm_source=noscript">
  </noscript>
</head>
<body>
  <!-- Пользователь ничего не увидит -->
</body>
</html>
